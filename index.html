<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> 
<html xmlns="http://www.w3.org/1999/xhtml"> 
<head> 
<title>Treasure Hunt</title> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> 
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.0/dist/leaflet.css" />

<link rel="stylesheet" href="leaflet-gps.css" />
<link rel="stylesheet" href="style.css" />
</head>

<body>

			<!--<video id="preview"></video>-->

<div id="map"></div>
<a style="color:white;font-size:x-small;" onclick="toggleFullScreen()">F</a>

<script src="https://unpkg.com/leaflet@1.3.0/dist/leaflet.js"></script>
<script src="leaflet-gps.js"></script>

<script type="text/javascript" src="instascan2.min.js"></script>

    <script>
function toggleFullScreen() {
  if (!document.fullscreenElement) {
      document.documentElement.requestFullscreen();
  } else {
    if (document.exitFullscreen) {
      document.exitFullscreen(); 
    }
  }
}
    </script>


    <script type="text/javascript">


var map = new L.Map('map', {
	zoom: 18,
	zoomControl: false,
	minZoom:16,
	center: new L.latLng([51.479683,-2.572701])
});

var parchmentIcon = L.icon({
    iconUrl: 'img/parchment-icon.svg',
    iconSize: [38, 95],
    iconAnchor: [19, 47]
});

var peopleIcon = L.icon({
    iconUrl: 'img/users-group.svg',
    iconSize: [38, 95],
    iconAnchor: [19, 47]
});

var peopleMarker = new L.Marker([0,0], {icon:peopleIcon});
peopleMarker.addTo(map);

var markers = [L.marker([51.4796, -2.573], {icon: parchmentIcon}), // clue 1
	L.marker([51.4786, -2.5717], {icon: parchmentIcon}), // clue 2
	L.marker([51.48, -2.5729], {icon: parchmentIcon}), // clue 3
	L.marker([51.4790, -2.5720], {icon: parchmentIcon})]; // clue 4

var activeMarker = null;

function hideAllMarkers() {

	for(var i = 0, size = markers.length; i < size ; i++){
		markers[i].remove();
	}
	activeMarker = null;

}

let scanner = new Instascan.Scanner({ video: document.getElementById('preview') });

scanner.addListener('scan', function (content) {
	//alert("You've found the clue " + content);

	hideAllMarkers();
	if (content == "clue1") {
		markers[0].addTo(map);
		activeMarker = markers[0];
	}
	if (content == "clue2") {
		markers[1].addTo(map);
		activeMarker = markers[1];
	}
	if (content == "clue3") {
		markers[2].addTo(map);
		activeMarker = markers[2];
	}
	if (content == "clue4") {
		markers[3].addTo(map);
		activeMarker = markers[3];
	}
});

Instascan.Camera.getCameras().then(function (cameras) {
	if (cameras.length > 0) {
		scanner.start(cameras[0]);
	} else {
		console.error('No cameras found.');
	}
}).catch(function (e) {
	console.error(e);
});


map.addLayer(new L.TileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'));	//base layer

var gps = new L.Control.Gps({
    //autoActive:true,
    //autoCenter:true,
    //style:{radius:20,color:'#511',fillColor:'#700'},
	//marker: new L.Marker([0,0], {icon:peopleIcon}),
});//inizialize control

gps
    .on('gps:located', function(e) {
        e.marker.bindPopup(e.latlng.toString()).openPopup()
        console.log(e.latlng, map.getCenter())
    })
    .on('gps:disabled', function(e) {
        e.marker.closePopup()
    });

gps.addTo(map);
gps.activate();


var polyline = null;

function updatePos() {
	latlng = gps.getLocation();
	if (latlng) {
	peopleMarker.setLatLng(latlng);
        console.log(latlng, map.getCenter());

	if (activeMarker) {
		if (polyline) {
			polyline.remove();
		}

		polyline = L.polyline([peopleMarker.getLatLng(), activeMarker.getLatLng()], {color: 'red'}).addTo(map);
		// zoom the map to the polyline
		map.fitBounds(polyline.getBounds());
	}
	
	}
	
}

window.setInterval(updatePos, 1000);

</script>

</body>
</html>
